import sinon from 'sinon';
import chai from 'chai';
const expect = chai.expect;
import * as fetch from '../../../src/functions/fetch.js';
import checkWordpress from '../../../src/wordpress/wordpress';

describe('wordpress', function() {
  describe('test wordpress promise', function() {
    let sandbox;

    beforeEach(function() {
      sandbox = sinon.sandbox.create();
    });

    afterEach(function() {
      sandbox.restore();
    });

    it('should return original URL even if not a WordPress site', () => {
      const html = {
        body: '<html><head><title>No index</title></head><body><h1>No index</h1></body></html>',
      };

      sandbox.stub(fetch, 'fetch').returns(html);

      return new Promise((resolve, reject) => {
        resolve('https://www.juffalow.com');
        })
        .then(checkWordpress)
        .then(() => {
          expect.fail(null, null, 'This promise in this test should end with error, therefore jump to catch');
        }).catch((error) => {
          expect(error).to.equal('Not a WordPress site!');
        });
    });

    it('should return original URL', () => {
      const html = {
        body: '<html><head><title>Index of folder</title><link href="https://example.com/wp-content/themes/example/css/example.css" rel="stylesheet"></head><body><h1>Index of folder</h1></body></html>',
      };

      sandbox.stub(fetch, 'fetch').returns(html);

      return new Promise((resolve, reject) => {
        resolve('https://www.juffalow.com');
        })
        .then(checkWordpress)
        .then((url) => {
          expect(url).to.equal('https://www.juffalow.com');
        });
    });
  });
});
