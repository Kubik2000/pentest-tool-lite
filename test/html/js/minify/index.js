import sinon from 'sinon';
import chai from 'chai';
const expect = chai.expect;
import * as fetch from '../../../../src/functions/fetch.js';
import checkMinifiedJs from '../../../../src/html/js/minify';

describe('html', function() {
  describe('js', function() {
    describe('test minify promise', function() {
      let sandbox;

      beforeEach(function() {
        sandbox = sinon.sandbox.create();
      });

      afterEach(function() {
        sandbox.restore();
      });

      it('should return array of results, with one result, that contains errors', () => {
        const html = {
          url: 'https://juffalow.com/',
          body: '<html><head><link rel="stylesheet" href="https://juffalow.com/cssfile.css" /></head><body><p>Text</p><a href="#">link</a><script src="https://juffalow.com/jsfile.js"></script></body></html>',
        };

        const result = {
          url: 'https://juffalow.com/jsfile.js',
          body: 'function something(text) { console.log("not minified javascript file"); }',
          response: {
            statusCode: 200,
          },
        };

        sandbox.stub(fetch, 'fetch').callsFake((url) => {
          switch (url) {
            case 'https://juffalow.com/':
              return html;
            case 'https://juffalow.com/jsfile.js':
              return result;
          }
        });

        return checkMinifiedJs('https://juffalow.com/')
          .then((results) => {
            expect(results.length).to.equal(1);
            expect(results[0].messages.length).to.equal(0);
            expect(results[0].errors.length).to.equal(1);
          });
      });
    });
  });
});
