import sinon from 'sinon';
import chai from 'chai';
const expect = chai.expect;
import * as fetch from '../../../src/functions/fetch.js';
import checkCookies from '../../../src/security/cookies';

describe('security', function() {
  describe('test cookies promise', function() {
    let sandbox;

    beforeEach(function() {
      sandbox = sinon.sandbox.create();
    });

    afterEach(function() {
      sandbox.restore();
    });

    it('should return array of results, with one result, that contains errors', () => {
      const result = {
        response: {
          headers: {
            'set-cookie': [
              'some-token',
              'another-cookie-text; HttpOnly',
            ],
          },
        },
      };

      sandbox.stub(fetch, 'fetch').returns(result);

      return checkCookies('http://juffalow.com/')
        .then((r) => {
          expect(r.messages.length).to.equal(0);
          expect(r.errors.length).to.equal(2);
        });
    });

    it('should return array of results, with one result, that contains messages', () => {
      const result = {
        response: {
          headers: {
            'set-cookie': [
              'some-token; secure; HttpOnly',
              'another-cookie-text; secure; HttpOnly',
            ],
          },
        },
      };

      sandbox.stub(fetch, 'fetch').returns(result);

      return checkCookies('http://juffalow.com/')
        .then((r) => {
          expect(r.messages.length).to.equal(1);
          expect(r.errors.length).to.equal(0);
        });
    });
  });
});
