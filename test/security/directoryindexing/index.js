import sinon from 'sinon';
import chai from 'chai';
const expect = chai.expect;
import * as fetch from '../../../src/functions/fetch.js';
import checkDirectoryIndexing from '../../../src/security/directoryindexing';

describe('security', function() {
  describe('test directoryIndexing promise', function() {
    let sandbox;

    beforeEach(function() {
      sandbox = sinon.sandbox.create();
    });

    afterEach(function() {
      sandbox.restore();
    });

    it('should return array of results, with one result, that contains errors', () => {
      const html = {
        url: 'https://juffalow.com/',
        body: '<html><head><link rel="stylesheet" href="https://juffalow.com/css/cssfile.css" /></head><body><p>Text</p><a href="#">link</a></body></html>',
      };

      const result = {
        url: 'https://juffalow.com/css/',
        body: '<html><head><title>Index of folder</title></head><body><h1>Index of folder</h1></body></html>',
        response: {
          statusCode: 200,
        },
      };

      sandbox.stub(fetch, 'fetch').callsFake((url) => {
        switch (url) {
          case 'https://juffalow.com/':
            return html;
          case 'https://juffalow.com/css/':
            return result;
        }
      });

      return checkDirectoryIndexing('https://juffalow.com/')
        .then((results) => {
          expect(results.length).to.equal(1);
          expect(results[0].messages.length).to.equal(0);
          expect(results[0].errors.length).to.equal(2);
        });
    });

    it('should return array of results, with one result, that contains messages', () => {
      const html = {
        url: 'https://juffalow.com/',
        body: '<html><head><link rel="stylesheet" href="https://juffalow.com/css/cssfile.css" /></head><body><p>Text</p><a href="#">link</a></body></html>',
      };

      const result = {
        url: 'https://juffalow.com/css/',
        body: '<html><head><title>No index</title></head><body><h1>No index</h1></body></html>',
        response: {
          statusCode: 200,
        },
      };

      sandbox.stub(fetch, 'fetch').callsFake((url) => {
        switch (url) {
          case 'https://juffalow.com/':
            return html;
          case 'https://juffalow.com/css/':
            return result;
        }
      });

      return checkDirectoryIndexing('https://juffalow.com/')
        .then((results) => {
          expect(results.length).to.equal(1);
          expect(results[0].messages.length).to.equal(1);
          expect(results[0].errors.length).to.equal(0);
        });
    });
  });
});
