import request from 'request';
import winston from 'winston';
import outcome from '../outcome';

const checkHttps = function(url) {
  return function() {
    return new Promise(function(resolve, reject) {
      const checkUrl = url.replace('https://', 'http://');

      winston.info('Checking HTTPS...');
      winston.debug('requesting', checkUrl);

      request({ url: checkUrl, followRedirect: false }, function(error, response, body) {
        winston.debug('checking Location header...');
        if (!(response.headers.hasOwnProperty('Location') || response.headers.hasOwnProperty('location'))) {
          outcome.error('Missing location header to redirect user!');
        }

        winston.debug('checking status code...');
        if (response.statusCode !== 301 && response.statusCode !== 302 && response.statusCode !== 307 && response.statusCode !== 308) {
          outcome.warning('Wrong status code!');
        }

        resolve();
      });
    });
  };
};

export default checkHttps;
