import winston from 'winston';
import jsdom from 'jsdom';
import RequestCache from '../request-cache';
const { JSDOM } = jsdom;

/*
 * Downloads the page and then parses HTML content
 * from this content it retrieves all src attribute from javascripts and images
 * to forward it.
 * WARNING: it returns only resources on the same domain
 */
const getResources = function(url) {
  return function() {
    return new Promise(function(resolve, reject) {
      winston.info('Getting resources...');

      RequestCache.request(url, function(error, response, body) {
        const dom = new JSDOM(body);
        const resources = [];
        const baseUrl = url.substring(0, url.indexOf('/', url.indexOf('://') + 3));

        Object.keys(dom.window.document.images).forEach((key, value) => {
          dom.window.document.images[key].src.startsWith(baseUrl) && resources.push(dom.window.document.images[key].src);
        });

        Object.keys(dom.window.document.scripts).forEach((key, value) => {
          dom.window.document.scripts[key].src.startsWith(baseUrl) && resources.push(dom.window.document.scripts[key].src);
        });

        resolve(resources);
      });
    });
  };
};

export default getResources;
