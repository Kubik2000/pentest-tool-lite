import request from 'request';
import winston from 'winston';
import outcome from '../outcome';

const checkContentSecurityPolicy = function(url) {
  return function() {
    return new Promise(function(resolve, reject) {
      winston.info('Checking Content-Security-Policy...');

      request({ url: url, followRedirect: false }, function(error, response, body) {

        const headers = {};
        Object.keys(response.headers).forEach((key, value) => {
          headers[key.toLowerCase()] = value;
        });

        winston.debug('checking Content-Security-Policy...');
        if (!headers.hasOwnProperty('content-security-policy')) {
          outcome.error('default', 'Missing Content-Security-Policy header!');
        }

        resolve();
      });
    });
  };
};

export default checkContentSecurityPolicy;
