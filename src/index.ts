#!/usr/bin/env node

import { Command } from 'commander';
import readline from 'readline';
import { URL } from 'url';
import { version } from '../package.json';
import Sitemap from './commands/Sitemap';
import Factory from './common/Factory';
import config from './config';
import HTML from './html/HTML';
import CommandLine from './report/CommandLine';
import Security from './security/Security';

const program = new Command();

program
  .usage('[options] <URL>')
  .version(version)
  .description(`
    Check your website ( or any other website ) for common vulnerabilities.
  `)
  .option('--grep <tests>', 'only run tests matching tests separated by comma', (value) => value.split(','), [])
  .option('--exclude <tests>', 'exclude tests matching tests separated by comma', (value) => value.split(','), [])
  .option('--no-cache', 'do not use cache for requests', false)
  .option('--logger <level>', 'DEBUG, INFO, VERBOSE, WARNING, ERROR, WTF', 'ERROR')
  .action(async (url: string, options) => {
    const useConfig = {
      ...config,
      ...{
        exclude: options.exclude,
        grep: options.grep,
        logger: {
          level: options.logger,
        },
        request: {
          cache: {
            type: options.cache ? 'UNLIMITED' : 'BLACK_HOLE',
          },
        },
      },
    };

    const factory = new Factory(useConfig);
    const security = new Security(factory, useConfig);
    const html = new HTML(factory, useConfig);

    const results = [
      await security.run(url),
      await html.run(url),
    ];

    const commandLine = new CommandLine();
    commandLine.write(results);
  });

program
  .command('sitemap <URL>')
  .description(`
    List all URLs in sitemap.
  `)
  .option('--path', 'path to sitemap', 'sitemap.xml')
  .action(async (url: string) => {
    const factory = new Factory();
    const sitemap = new Sitemap(factory.getRequest());
    const urls = await sitemap.run(url);
    /* tslint:disable-next-line:no-console */
    urls.forEach((sitemapUrl: string) => console.log(sitemapUrl));
  });

program
  .command('random')
  .description(`
    List all URLs in sitemap.
  `)
  .option('--probability', 'the chance the line will pass', 10)
  .action(() => {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
      terminal: false,
    });

    rl.on('line', (line) => {
      try {
        /* tslint:disable-next-line:no-unused-expression */
        new URL(line);
        if (Math.random() <= 0.1) {
          /* tslint:disable-next-line:no-console */
          console.log(line);
        }
      } catch {
        return;
      }
    });
  });

program.parse(process.argv);
