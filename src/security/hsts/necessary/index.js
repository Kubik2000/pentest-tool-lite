import * as fetch from '../../../functions/fetch.js';
import hsts from '../hsts.js';

export default function(url) {
  return Promise.resolve(url)
    .then(fetch.fetch)
    .then((http) => {
      const result = {
        url: http.url,
        importance: 70,
        messages: [],
        errors: [],
      };
      try {
        if (http.url.startsWith('http://')) {
          throw new Error('Not even HTTPS!');
        }
        hsts(http);
        result.messages.push('HSTS is set properly!');
        result.messages.push('Strict-Transport-Security: ' + http.response.headers['strict-transport-security']);
      } catch(exception) {
        switch(exception.message) {
          case 'HSTS is not set properly!':
            result.errors.push('Strict-Transport-Security header is missing!');
            break;
          case 'Max-age too low!':
            result.errors.push('The max-age attribute is less then 31536000 seconds!');
            break;
          default:
            result.errors.push('HSTS is not set properly!');
        }
        result.errors.push('For more informations visit [see this page](https://github.com/juffalow/pentest-tool-lite/tree/master/src/security#hsts).');
      }
      return result;
    });
};
