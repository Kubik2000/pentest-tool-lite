import { fetchWithoutRedirect } from '../../../functions/fetch.js';
import httpsToHttp from '../../https/httpsToHttp.js';
import hsts from '../hsts.js';

export default function(url) {
  return Promise.resolve(url)
    .then(httpsToHttp)
    .then(fetchWithoutRedirect)
    .then((http) => {
      const result = {
        url: http.url,
        importance: 70,
        messages: [],
        errors: [],
      };
      try {
        hsts(http);
        result.errors.push('Unnecessary HSTS header over HTTP!');
        result.errors.push('The HTTP page at ' + http.url + ' sends an HSTS header. This has no effect over HTTP, and should be removed.');
        result.errors.push('For more informations visit [see this page](https://github.com/juffalow/pentest-tool-lite/tree/master/src/security#hsts).');
      } catch(exception) {

      }
      return result;
    });
};
