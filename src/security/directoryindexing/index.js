import * as fetch from '../../functions/fetch.js';
import parseHtml from '../../functions/parseHtml.js';
import getResources from '../../functions/getResources.js';
import resourcesToDirectories from '../../functions/resourcesToDirectories.js';
import checkDirectoryIndexing from './directoryIndexing';
import { URL } from 'url';

export default function(url) {
  return Promise.resolve(url)
    .then(fetch.fetch)
    .then(parseHtml)
    .then(getResources)
    .then(resourcesToDirectories)
    .then((urls) => {
      const origin = (new URL(url)).origin;
      urls = urls.filter((singleUrl) => {
        return singleUrl.startsWith(origin) && singleUrl !== origin && singleUrl !== origin + '/';
      });
      return Promise.all(urls.map((singleUrl) => {
        return Promise.resolve(singleUrl)
          .then(fetch.fetch)
          .then((http) => {
            const result = {
              url: http.url,
              messages: [],
              errors: [],
            };
            try {
              checkDirectoryIndexing(http);
              result.messages.push('Directory indexing is disabled!');
            } catch(exception) {
              result.errors.push('Directory indexing is enabled!');
              result.errors.push('For more informations visit [see this page](https://github.com/juffalow/pentest-tool-lite/tree/master/src/security#directory-indexing).');
            }
            return result;
          });
      }));
    });
};
