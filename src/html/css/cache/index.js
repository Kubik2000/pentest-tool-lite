import * as fetch from '../../../functions/fetch.js';
import parseHtml from '../../../functions/parseHtml.js';
import getResources from '../../../functions/getResources.js';
import onlyCssFiles from '../onlyCssFiles.js';
import onlyAvailable from '../available';
import checkCache from '../../cache/cache.js';

export default function(url) {
  return Promise.resolve(url)
    .then(fetch.fetch)
    .then(parseHtml)
    .then(getResources)
    .then(onlyCssFiles)
    .then(onlyAvailable)
    .then((urls) => {
      return Promise.all(urls.map((singleUrl) => {
        return Promise.resolve(singleUrl)
          .then(fetch.fetch)
          .then((http) => {
            const result = {
              url: http.url,
              messages: [],
              errors: [],
            };
            try {
              checkCache(http);
              result.messages.push('CSS is cached!');
              result.messages.push('Cache-Control: ' + http.response.headers['cache-control']);
            } catch(exception) {
              result.errors.push('Missing Cache-Control header!');
            }
            return result;
          });
      }));
    });
};
