import * as fetch from '../../../functions/fetch.js';
import parseHtml from '../../../functions/parseHtml.js';
import getResources from '../../../functions/getResources.js';
import onlyCssFiles from '../onlyCssFiles.js';
import onlyAvailable from '../available';
import checkXContentTypeOptions from '../../xcontenttypeoptions/xContentTypeOptions.js';

export default function(url) {
  return Promise.resolve(url)
    .then(fetch.fetch)
    .then(parseHtml)
    .then(getResources)
    .then(onlyCssFiles)
    .then(onlyAvailable)
    .then((urls) => {
      return Promise.all(urls.map((singleUrl) => {
        return Promise.resolve(singleUrl)
          .then(fetch.fetch)
          .then((http) => {
            const result = {
              url: http.url,
              messages: [],
              errors: [],
            };
            try {
              checkXContentTypeOptions(http);
              result.messages.push('CSS has X-Content-Type-Options header!');
              result.messages.push('X-Content-Type-Options: ' + http.response.headers['x-content-type-options']);
            } catch(exception) {
              result.errors.push('Missing X-Content-Type-Options header!');
              result.errors.push('For more informations visit [see this page](https://github.com/juffalow/pentest-tool-lite/blob/master/src/html/README.md#x-content-type-options).');
            }
            return result;
          });
      }));
    });
};
