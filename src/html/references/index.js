import * as fetch from '../../functions/fetch';
import parseHtml from '../../functions/parseHtml.js';
import getReferences from '../../functions/getReferences.js';

export default function(url) {
  return Promise.resolve(url)
    .then(fetch.fetch)
    .then(parseHtml)
    .then(getReferences)
    .then((urls) => {
      return Promise.all(urls.map((singleUrl) => {
        return Promise.resolve(singleUrl)
          .then(fetch.fetch)
          .then((http) => {
            const result = {
              url: http.url,
              messages: [],
              errors: [],
            };
            if (http.response.statusCode === 404) {
              result.errors.push('Reference is not available!');
              result.errors.push('This reference (link) is not valid anymore. The content was deleted or moved to another URL.');
            } else if (parseInt(http.response.statusCode / 100) === 3) {
              result.errors.push('Reference is redirected!');
              result.errors.push('You may want to check the reference (link) if it is still pointing on the same content.');
            }
            return result;
          });
      }));
    });
};
