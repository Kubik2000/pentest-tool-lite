var request = require('request');
var program = require('commander');

const checkHttps = function(url) {
  return function() {
    return new Promise(function(resolve, reject) {
      program.verbose && console.log('Checking HTTPS...', url);
      if (url.substring(0, 5) === 'http:') {
        resolve();
      } else {
        const checkUrl = url.replace('https://', 'http://');
        request({ url: checkUrl, followRedirect: false }, function(error, response, body) {
          if (!(response.headers.hasOwnProperty('Location') || response.headers.hasOwnProperty('location'))) {
            console.log('Location!');
          }

          program.debug && console.log('status code', response.statusCode);

          if (response.statusCode !== 301 && response.statusCode !== 302 && response.statusCode !== 307 && response.statusCode !== 308) {
            console.log('Wrong status code!');
          }

          resolve();
        });
      }
    });
  }
}

module.exports = function(url) {
  let chain = Promise.resolve();

  chain = chain.then(checkHttps(url));

  chain.then(() => { console.log('done!'); });
}
