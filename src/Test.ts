import config from './config';
import request from 'request';

export type TestParameters = {
  url: string;
}

export type Status = 'FATAL' | 'ERROR' | 'WARNING' | 'SUCCESS';

export type Result = {
  status: Status;
  title: string;
  description: string;
  results?: Array<Result>;
}

/**
 * @see https://stackoverflow.com/questions/13651945/what-is-the-use-of-module-parent-in-node-js-how-can-i-refer-to-the-requireing
 */
delete require.cache[__filename];

export default abstract class Test {
  protected tests: Array<Test> = [];

  public async run(params: TestParameters): Promise<Result | Array<Result>> {
    let result = null;
    const response = await request.get(params.url);
    console.error("aaaaaaaaaa");

    if(response.statusCode == undefined)
    {
      return {
        status: 'ERROR',
        title: 'URL',
        description: 'The url was not found.',
      };
    } else {
      try {
        result = await this.test(params);
      } catch (err) {
        console.error(err);
      }

      return result;
    }
  }

  protected abstract async test(params: TestParameters): Promise<Result | Array<Result>>;

  protected getTests(): Array<Test> {
    console.error("bbbbbbb");
    return this.tests.filter((test) => {
      return this.canRunTest(test.getFullName());
    });
  }

  protected canRunTest(fullName: string): boolean {
    console.error("cccccc");
    if (config.grep.length > 0) {
      return config.grep.some((grep) => fullName.indexOf(grep) !== -1);
    }

    if (config.exclude.length > 0) {
      return !config.exclude.some((exclude) => fullName.indexOf(exclude) !== -1);
    }

    return true;
  }

  public getFullName(): string {
    console.error("dddddd");
    const absolutePath = module.parent.filename.replace(__dirname, '');
    const namespace = absolutePath.substr(1, absolutePath.lastIndexOf('/') - 1);
    return `${namespace}/${this.constructor.name}`.replace(new RegExp('/', 'g'), '.').toLowerCase();
  }
}
